function YM2612(){if(!this instanceof YM2612){return new YM2612();}var x={hq_fm:0,dac_bits:8,debug:0};var e={};e.FREQ_SH=16;e.EG_SH=16;e.LFO_SH=24;e.TIMER_SH=16;e.FREQ_MASK=(1<<e.FREQ_SH)-1;var a={};a.BITS=10;a.LEN=1<<a.BITS;a.STEP=128/a.LEN;a.MAX_ATT_INDEX=a.LEN-1;a.MIN_ATT_INDEX=0;var o={};o.ATT=4;o.DEC=3;o.SUS=2;o.REL=1;o.OFF=0;e.SIN_BITS=10;e.SIN_LEN=1<<e.SIN_BITS;e.SIN_MASK=e.SIN_LEN-1;var p={};p.RES_LEN=256;p.TAB_LEN=13*2*p.RES_LEN;p.tab=new Array(p.TAB_LEN);a.QUIET=p.TAB_LEN>>3;e.sin=new Array(e.SIN_LEN);e.sl=(function(){var z=function(A){return A*4/a.STEP;};return[z(0),z(1),z(2),z(3),z(4),z(5),z(6),z(7),z(8),z(9),z(10),z(11),z(12),z(13),z(14),z(31)];})();o.RATE_STEPS=8;o.inc=[0,1,0,1,0,1,0,1,0,1,0,1,1,1,0,1,0,1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1,1,1,2,1,2,1,2,1,2,1,2,1,2,2,2,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,4,2,2,2,4,2,4,2,4,2,4,2,4,2,4,4,4,2,4,4,4,4,4,4,4,4,4,4,4,4,4,4,8,4,4,4,8,4,8,4,8,4,8,4,8,4,8,8,8,4,8,8,8,8,8,8,8,8,8,8,8,16,16,16,16,16,16,16,16,0,0,0,0,0,0,0,0,];o.rate_select=(function(){var z=function(A){return A*o.RATE_STEPS;};return[z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(18),z(0),z(0),z(0),z(0),z(2),z(2),z(0),z(1),z(2),z(3),z(0),z(1),z(2),z(3),z(0),z(1),z(2),z(3),z(0),z(1),z(2),z(3),z(0),z(1),z(2),z(3),z(0),z(1),z(2),z(3),z(0),z(1),z(2),z(3),z(0),z(1),z(2),z(3),z(0),z(1),z(2),z(3),z(0),z(1),z(2),z(3),z(4),z(5),z(6),z(7),z(8),z(9),z(10),z(11),z(12),z(13),z(14),z(15),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16),z(16)];})();o.rate_shift=(function(){var z=function(A){return A*1;};return[z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(11),z(10),z(10),z(10),z(10),z(9),z(9),z(9),z(9),z(8),z(8),z(8),z(8),z(7),z(7),z(7),z(7),z(6),z(6),z(6),z(6),z(5),z(5),z(5),z(5),z(4),z(4),z(4),z(4),z(3),z(3),z(3),z(3),z(2),z(2),z(2),z(2),z(1),z(1),z(1),z(1),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0),z(0)];})();o.dt_tab=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,2,2,2,2,2,3,3,3,4,4,4,5,5,6,6,7,8,8,8,8,1,1,1,1,2,2,2,2,2,3,3,3,4,4,4,5,5,6,6,7,8,8,9,10,11,12,13,14,16,16,16,16,2,2,2,2,2,3,3,3,4,4,4,5,5,6,6,7,8,8,9,10,11,12,13,14,16,17,19,20,22,22,22,22];var h={};h.fktable=[0,0,0,0,0,0,0,1,2,3,3,3,3,3,3,3];var d={};d.samples_per_step=[108,77,71,67,62,44,8,5];d.ams_depth_shift=[8,3,1,0];d.pm_output=[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,1,1,1,1],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,1,1,1,1],[0,0,1,1,2,2,2,3],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1],[0,0,0,0,1,1,1,1],[0,0,1,1,2,2,2,3],[0,0,2,3,4,4,5,6],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,1],[0,0,0,0,1,1,1,1],[0,0,0,1,1,1,1,2],[0,0,1,1,2,2,2,3],[0,0,2,3,4,4,5,6],[0,0,4,6,8,8,10,12],[0,0,0,0,0,0,0,0],[0,0,0,0,1,1,1,1],[0,0,0,1,1,1,2,2],[0,0,1,1,2,2,3,3],[0,0,1,2,2,2,3,4],[0,0,2,3,4,4,5,6],[0,0,4,6,8,8,10,12],[0,0,8,12,16,16,20,24],[0,0,0,0,0,0,0,0],[0,0,0,0,2,2,2,2],[0,0,0,2,2,2,4,4],[0,0,2,2,4,4,6,6],[0,0,2,4,4,4,6,8],[0,0,4,6,8,8,10,12],[0,0,8,12,16,16,20,24],[0,0,16,24,32,32,40,48],[0,0,0,0,0,0,0,0],[0,0,0,0,4,4,4,4],[0,0,0,4,4,4,8,8],[0,0,4,4,8,8,12,12],[0,0,4,8,8,8,12,16],[0,0,8,12,16,16,20,24],[0,0,16,24,32,32,40,48],[0,0,32,48,64,64,80,96]];d.pm_table=new Array(128*8*32);h.CHAN=function(z){return z&3;};h.SLOT=function(z){return(z>>2)&3;};var c=[0,2,1,3];function w(){this.DT=[];this.KSR=0;function z(){this.ar=0;this.d1r=0;this.d2r=0;this.rr=0;this.ksr=0;this.mul=1;this.init=function(){this.ar=0;this.d1r=0;this.d2r=0;this.rr=0;this.ksr=0;this.mul=1;};}this.rate=new z();this.phase=0;this.Incr=0;this.state=0;this.tl=0;this.volume=0;this.sl=0;this.vol_out=0;function A(){this.sh_ar=0;this.sel_ar=0;this.sh_d1r=0;this.sel_d1r=0;this.sh_d2r=0;this.sel_d2r=0;this.sh_rr=0;this.sel_rr=0;this.init=function(){this.sh_ar=0;this.sel_ar=0;this.sh_d1r=0;this.sel_d1r=0;this.sh_d2r=0;this.sel_d2r=0;this.sh_rr=0;this.sel_rr=0;};}this.eg=new A();this.ssg=0;this.ssgn=0;this.key=0;this.AMmask=0;this.init=function(){this.KSR=0;this.rate.init();this.phase=0;this.Incr=0;this.state=0;this.tl=0;this.volume=0;this.sl=0;this.vol_out=0;this.eg.init();this.ssg=0;this.ssgn=0;this.key=0;this.AMmask=0;};}w.prototype.set_det_mul=function(z){this.mul=(z&15)?(z&15)<<1:1;this.DT=b.OPN.ST.dt_tab[(z>>4)&7];};w.prototype.set_tl=function(z){this.tl=(z&127)<<a.BITS-7;if((this.ssg&8)&&(this.ssgn^(this.ssg&4))&&this.state>o.REL){this.vol_out=((512-this.volume)|0)&a.MAX_ATT_INDEX+this.tl;}else{this.vol_out=((this.volume)|0)+this.tl;}};w.prototype.set_ar_ksr=function(z){var A=this.KSR;this.rate.ar=(z&31)?32+((z&31)<<1):0;this.KSR=3-(z>>6);if((this.rate.ar+this.rate.ksr)<(32+62)){this.eg.sh_ar=o.rate_shift[this.rate.ar+this.rate.ksr];this.eg.sel_ar=o.rate_select[this.rate.ar+this.rate.ksr];}else{this.eg.sh_ar=0;this.eg.sel_ar=18*o.RATE_STEPS;}return A;};w.prototype.set_dr=function(z){this.rate.d1r=(z&31)?32+((z&31)<<1):0;this.eg.sh_d1r=o.rate_shift[this.rate.d1r+this.rate.ksr];this.eg.sel_d1r=o.rate_select[this.rate.d1r+this.rate.ksr];};w.prototype.set_sr=function(z){this.rate.d2r=(z&31)?32+((z&31)<<1):0;this.eg.sh_d2r=o.rate_shift[this.rate.d2r+this.rate.ksr];this.eg.sh_d2r=o.rate_select[this.rate.d2r+this.rate.ksr];};w.prototype.set_sl_rr=function(z){this.sl=e.sl[z>>4];if(this.state===o.DEC&&this.volume>=this.sl){this.state=o.SUS;}this.rate.rr=34+((z&15)<<2);this.eg.sh_rr=o.rate_shift[this.rate.rr+this.rate.ksr];this.eg.sel_rr=o.rate_select[this.rate.rr+this.rate.ksr];};w.prototype.advance_eg_channel=function(){var z=b.OPN.eg.cnt;switch(this.state){case o.ATT:if(!(z&((1<<this.eg.sh_ar)-1))){this.volume+=(~this.volume*o.inc[this.eg.sel_ar+((z>>this.eg.sh_ar)&7)])>>4;if(this.volume<=a.MIN_ATT_INDEX){this.volume=a.MIN_ATT_INDEX;this.state=this.sl===a.MIN_ATT_INDEX?o.SUS:o.DEC;}if((this.ssg&8)&&(this.ssgn^(this.ssg&4))){this.vol_out=(((512-this.volume)|0)&a.MAX_ATT_INDEX)+this.tl;}else{this.vol_out=((this.volume)|0)+this.tl;}}break;case o.DEC:if(!(z&((1<<this.eg.sh_d1r)-1))){if(this.ssg&8){if(this.volume<512){this.volume+=4*o.inc[this.eg.sel_d1r+((z>>this.eg.sh_d1r)&7)];if(this.ssgn^(this.ssg&4)){this.vol_out=(((512-this.volume)|0)&a.MAX_ATT_INDEX)+this.tl;}else{this.vol_out=((this.volume)|0)+this.tl;}}}else{this.volume+=o.inc[this.eg.sel_d1r+((z>>this.eg.sh_d1r)&7)];this.vol_out=((this.volume)|0)+this.tl;}if(this.volume>=this.sl){this.state=o.SUS;}}break;case o.SUS:if(!(z&((1<<this.eg.sh_d2r)-1))){if(this.ssg&8){if(this.volume<512){this.volume+=4*o.inc[this.eg.sel_d2r+((z>>this.eg.sh_d2r)&7)];if(this.ssgn^(this.ssg&4)){this.vol_out=(((512-this.volume)|0)&a.MAX_ATT_INDEX)+this.tl;}else{this.vol_out=((this.volume)|0)+this.tl;}}}else{this.volume+=o.inc[this.eg.sel_d2r+((z>>this.eg.sh_d2r)&7)];if(this.volume>=a.MAX_ATT_INDEX){this.volume=a.MAX_ATT_INDEX;}this.vol_out=((this.volume)|0)+this.tl;}}break;case o.REL:if(!(z&((1<<this.eg.sh_rr)-1))){if(this.ssg&8){if(this.volume<512){this.volume+=4*o.inc[this.eg.sel_rr+((z>>this.eg.sh_rr)&7)];}if(this.volume>=512){this.volume=a.MAX_ATT_INDEX;this.state=o.OFF;}}else{this.volume+=o.inc[this.eg.sel_rr+((z>>this.eg.sh_rr)&7)];if(this.volume>=a.MAX_ATT_INDEX){this.volume=a.MAX_ATT_INDEX;this.state=o.OFF;}}this.vol_out=((this.volume)|0)+this.tl;}break;}};w.prototype.update_ssg_eg=function(){if((this.ssg&8)&&this.volume>=512&&this.state>o.REL){if(this.ssg&1){if(this.ssg&2){this.ssgn=4;}if(this.state!==o.ATT&&!(this.ssgn^(this.ssg&4))){this.volume=a.MAX_ATT_INDEX;}}else{if(this.ssg&2){this.ssgn^=4;}else{this.phase=0;}if(this.state!==o.ATT){if((this.rate.ar+this.rate.ksr)<94){this.state=this.volume<=a.MIN_ATT_INDEX?(this.sl===a.MIN_ATT_INDEX?o.SUS:o.DEC):o.ATT;}else{this.volume=a.MIN_ATT_INDEX;this.state=this.sl===a.MIN_ATT_INDEX?o.SUS:o.DEC;}}}if(this.ssgn^(this.ssg&4)){this.vol_out=(((512-this.volume)|0)&a.MAX_ATT_INDEX)+this.tl;}else{this.vol_out=((this.volume)|0)+this.tl;}}};w.prototype.update_phase_lfo=function(D,E){var C=d.pm_table[(((E&2032)>>4)<<8)+D+b.OPN.lfo.PM];if(C){E=E*2+C;var z=(E&28672)>>12;E=block_num&4095;var A=(z<<2)|h.fktable[E>>8];var B=(b.OPN.fn.table[E]>>(7-z))+this.DT[A];if(B<0){B+=b.OPN.fn.max;}this.phase+=(B*this.rate.mul)>>1;}else{this.phase+=this.Incr;}};w.prototype.refresh_fc_eg=function(A,z){A+=this.DT[z];if(A<0){A+=b.OPN.fn.max;}this.Incr=(A*this.rate.mul)>>1;z=z>>this.KSR;if(this.rate.ksr!==z){this.rate.ksr=z;if((this.rate.ar+z)<(32+62)){this.eg.sh_ar=o.rate_shift[this.rate.ar+z];this.eg.sel_ar=o.rate_select[this.rate.ar+z];}else{this.eg.sh_ar=0;this.eg.sel_ar=18*o.RATE_STEPS;}this.eg.sh_d1r=o.rate_shift[this.rate.d1r+z];this.eg.sel_d1r=o.rate_select[this.rate.d1r+z];this.eg.sh_d2r=o.rate_shift[this.rate.d2r+z];this.eg.sel_d2r=o.rate_select[this.rate.d2r+z];this.eg.sh_rr=o.rate_shift[this.rate.rr+z];this.eg.sel_rr=o.rate_select[this.rate.rr+z];}};w.prototype.reset=function(){this.Incr=-1;this.key=0;this.phase=0;this.ssgn=0;this.state=o.OFF;this.volume=a.MAX_ATT_INDEX;this.vol_out=a.MAX_ATT_INDEX;};w.prototype.keyOn=function(){if(!this.key&&!b.OPN.SL3.key_csm){this.phase=0;this.ssgn=0;if((this.rate.ar+this.rate.ksr)<94){this.state=this.volume<=a.MIN_ATT_INDEX?(this.sl===a.MIN_ATT_INDEX?o.SUS:o.DEC):o.ATT;}else{this.volume=a.MIN_ATT_INDEX;this.state=this.sl===a.MIN_ATT_INDEX?o.SUS:o.DEC;}if((this.ssg&8)&&this.ssgn^(this.ssg&4)){this.vol_out=(((512-this.volume)|0)&a.MAX_ATT_INDEX)+this.tl;}else{this.vol_out=((this.volume+this.tl)|0);}}this.key=1;};w.prototype.keyOff=function(z){if(this.key&&!b.OPN.SL3.key_csm){if(this.state>o.REL){this.state=o.REL;if(this.ssg&8){if(this.ssgn^(this.ssg&4)){this.volume=512-this.volume;}if(this.volume>=512){this.volume=a.MAX_ATT_INDEX;this.state=o.OFF;}this.vol_out=((this.volume+this.tl)|0);}}}this.key=0;};w.prototype.calcVol=function(z){return this.vol_out+(z&this.AMmask);};e.m2=0;e.c1=0;e.c2=0;e.mem=0;e.out_fm=[0,0,0,0,0,0,0,0];e.limit=function(B,A,z){if(B>z){B=z;}else{if(B<A){B=A;}}return B;};function m(A){var z=A>0?A:-1;this.SLOT=[new w(),new w(),new w(),new w()];this.ALGO=0;this.FB=0;this.op1_out=[0,0];this.connect=[["out_fm",0],["out_fm",0],["out_fm",0],["out_fm",0]];this.mem={connect:0,value:0};this.pms=0;this.ams=0;this.fc=0;this.kcode=0;this.block_fnum=0;this.init=function(){var B;B=this.SLOT.length;while(--B>-1){this.SLOT[B].init();}this.ALGO=0;this.FB=0;B=this.op1_out.length;while(--B>-1){this.op1_out[B]=0;}B=this.connect.length;while(--B>-1){this.connect[B]=0;}this.pms=0;this.ams=0;this.fc=0;this.kcode=0;this.block_fnum=0;};this.__defineGetter__("id",function(){return z;});}m.prototype.advance_eg_channel=function(){var z=this.SLOT.length;while(--z>-1){this.SLOT[z].advance_eg_channel();}};m.prototype.update_ssg_eg=function(){var z=this.SLOT.length;while(--z>-1){this.SLOT[z].update_ssg_eg();}};m.prototype.update_phase_lfo=function(){var E=this.block_fnum;var C=d.pm_table[(((E&2032)>>4)<<8)+this.pms+b.OPN.lfo.PM];if(C){E=E*2+C;var z=(E&28672)>>12;E=E&4095;var A=(z<<2)|h.fktable[E>>8];var B=b.OPN.fn.table[E]>>(7-z);var D;D=B+this.SLOT[c[0]].DT[A];if(D<0){D+=b.OPN.fn.max;}this.SLOT[c[0]].phase+=(D*this.SLOT[c[0]].rate.mul)>>1;D=B+this.SLOT[c[1]].DT[A];if(D<0){D+=b.OPN.fn.max;}this.SLOT[c[1]].phase+=(D*this.SLOT[c[1]].rate.mul)>>1;D=B+this.SLOT[c[2]].DT[A];if(D<0){D+=b.OPN.fn.max;}this.SLOT[c[2]].phase+=(D*this.SLOT[c[2]].rate.mul)>>1;D=B+this.SLOT[c[3]].DT[A];if(D<0){D+=b.OPN.fn.max;}this.SLOT[c[2]].phase+=(D*this.SLOT[c[2]].rate.mul)>>1;}else{this.SLOT[c[0]].phase+=this.SLOT[c[0]].Incr;this.SLOT[c[1]].phase+=this.SLOT[c[1]].Incr;this.SLOT[c[2]].phase+=this.SLOT[c[2]].Incr;this.SLOT[c[3]].phase+=this.SLOT[c[3]].Incr;}};function g(z,B,A){var C=(B<<3)+e.sin[(((z&(~e.FREQ_MASK))+(A<<15))>>e.FREQ_SH)&e.SIN_MASK];if(C>=p.TAB_LEN){return 0;}return p.tab[C];}function f(z,B,A){var C=(B<<3)+e.sin[(((z&(~e.FREQ_MASK))+A)>>e.FREQ_SH)&e.SIN_MASK];if(C>=p.TAB_LEN){return 0;}return p.tab[C];}m.prototype.calculate=function(){var C=b.OPN.lfo.AM>>this.ams;e.m2=e.c1=e.c2=e.mem=0;e[this.mem.connect]=this.mem.value;var B=this.SLOT[c[0]].calcVol(C);var z=this.op1_out[0]+this.op1_out[1];this.op1_out[0]=this.op1_out[1];var A=[typeof this.connect[0],typeof this.connect[1],typeof this.connect[2],typeof this.connect[3]];if(this.connect[0]==="all"){e.mem=e.c1=e.c2=this.op1_out[0];}else{if(A[0]==="number"){throw new Error("YM::calc_ch - c"+this.id+"s"+c[0]+" connect="+this.connect[0]);}else{if(A[0]!=="string"){e[this.connect[0][0]][this.connect[0][1]]+=this.op1_out[0];}else{e[this.connect[0]]+=this.op1_out[0];}}}this.op1_out[1]=0;if(B<a.QUIET){if(!this.FB){z=0;}this.op1_out[1]=f(this.SLOT[c[0]].phase,B,z<<this.FB);}B=this.SLOT[c[2]].calcVol(C);if(B<a.QUIET){if(A[2]==="number"){throw new Error("YM::calc_ch - c"+this.id+"s"+c[2]+" connect="+this.connect[2]);}else{if(A[2]!=="string"){e[this.connect[2][0]][this.connect[2][1]]+=g(this.SLOT[c[2]].phase,B,e.m2);}else{e[this.connect[2]]+=g(this.SLOT[c[2]].phase,B,e.m2);}}}B=this.SLOT[c[1]].calcVol(C);if(B<a.QUIET){if(A[1]!=="string"){e[this.connect[1][0]][this.connect[1][1]]+=g(this.SLOT[c[1]].phase,B,e.c1);}else{e[this.connect[1]]+=g(this.SLOT[c[1]].phase,B,e.c1);}}B=this.SLOT[c[3]].calcVol(C);if(B<a.QUIET){if(A[3]==="number"){throw new Error("YM::calc_ch - c"+this.id+"s"+c[3]+" connect="+this.connect[3]);}else{if(A[3]!=="string"){e[this.connect[3][0]][this.connect[3][1]]+=g(this.SLOT[c[3]].phase,B,e.c2);}else{e[this.connect[3]]+=g(this.SLOT[c[3]].phase,B,e.c2);}}}this.mem.value=e.mem;if(this.pms){if((b.OPN.ST.mode&192)&&this.id===3){this.SLOT[c[0]].update_phase_lfo(this.pms,b.OPN.SL3.block_fnum[1]);this.SLOT[c[1]].update_phase_lfo(this.pms,b.OPN.SL3.block_fnum[2]);this.SLOT[c[2]].update_phase_lfo(this.pms,b.OPN.SL3.block_fnum[0]);this.SLOT[c[3]].update_phase_lfo(this.pms,this.block_fnum);}else{this.update_phase_lfo();}}else{this.SLOT[c[0]].phase+=this.SLOT[c[0]].Incr;this.SLOT[c[1]].phase+=this.SLOT[c[1]].Incr;this.SLOT[c[2]].phase+=this.SLOT[c[2]].Incr;this.SLOT[c[3]].phase+=this.SLOT[c[3]].Incr;}};m.prototype.refresh_fc_eg=function(){if(this.SLOT[c[0]].Incr===-1){var A=this.fc,z=this.kcode;this.SLOT[c[0]].refresh_fc_eg(A,z);this.SLOT[c[1]].refresh_fc_eg(A,z);this.SLOT[c[2]].refresh_fc_eg(A,z);this.SLOT[c[3]].refresh_fc_eg(A,z);}};m.prototype.set_det_mul=function(A,z){this.SLOT[A].set_det_mul(z);this.SLOT[c[0]].Incr=-1;};m.prototype.set_ar_ksr=function(A,z){var B=this.SLOT[A].set_ar_ksr(z);if(this.SLOT[A].KSR!==B){this.SLOT[c[0]].Incr=-1;}};m.prototype.reset=function(){this.mem.value=0;this.op1_out[0]=0;this.op1_out[1]=0;this.connect=[["out_fm",0],["out_fm",0],["out_fm",0],["out_fm",0]];s=-1;while(++s<4){this.SLOT[s].reset();}};m.prototype.setup_connection=function(z){switch(this.ALGO){case 0:this.connect[0]="c1";this.connect[1]="mem";this.connect[2]="c2";this.mem.connect="m2";break;case 1:this.connect[0]="mem";this.connect[1]="mem";this.connect[2]="c2";this.mem.connect="m2";break;case 2:this.connect[0]="c2";this.connect[1]="mem";this.connect[2]="c2";this.mem.connect="m2";break;case 3:this.connect[0]="c1";this.connect[1]="mem";this.connect[2]="c2";this.mem.connect="c2";break;case 4:this.connect[0]="c1";this.connect[1]=["out_fm",z];this.connect[2]="c2";this.mem.connect="mem";break;case 5:this.connect[0]="all";this.connect[1]=["out_fm",z];this.connect[2]=["out_fm",z];this.mem.connect="m2";break;case 6:this.connect[0]="c1";this.connect[1]=["out_fm",z];this.connect[2]=["out_fm",z];this.mem.connect="mem";break;case 7:this.connect[0]=["out_fm",z];this.connect[1]=["out_fm",z];this.connect[2]=["out_fm",z];this.mem.connect="mem";break;default:throw new Error("CH::setup_connection - unsupported algorithm ("+this.ALGO+")");}this.connect[3]=["out_fm",z];};function u(){this.clock=0;this.rate=0;this.address=0;this.status=0;this.mode=0;this.fn_h=0;this.TimerBase=0;this.TA=0;this.TAL=0;this.TAC=0;this.TB=0;this.TBL=0;this.TBC=0;this.dt_tab=[new Array(32),new Array(32),new Array(32),new Array(32),new Array(32),new Array(32),new Array(32),new Array(32)];this.init=function(){this.clock=0;this.rate=0;this.address=0;this.status=0;this.mode=0;this.fn_h=0;this.TimerBase=0;this.TA=0;this.TAL=0;this.TAC=0;this.TB=0;this.TBL=0;this.TBC=0;var z,A=this.dt_tab.length;while(--A>-1){z=this.dt_tab[A].length;while(--z>-1){this.dt_tab[A][z]=0;}}};}function q(){this.fc=[0,0,0];this.fn_h=0;this.kcode=[0,0,0];this.block_fnum=[0,0,0];this.key_csm=0;this.init=function(){var z;z=this.fc.length;while(--z>-1){this.fc[z]=0;}this.fn_h=0;z=this.kcode.length;while(--z>-1){this.kcode[z]=0;}z=this.block_fnum.length;while(--z>-1){this.block_fnum[z]=0;}this.key_csm=0;};}function v(){this.ST=new u;this.SL3=new q;this.pan=new Array(6*2);function z(){this.cnt=0;this.timer=0;this.timer_add=0;this.timer_overflow=0;this.init=function(){this.cnt=0;this.timer=0;this.timer_add=0;this.timer_overflow=0;};}this.eg=new z();this.fn={table:new Array(4096),max:0};this.lfo=new z();this.lfo.AM=0;this.lfo.PM=0;this.init=function(){this.ST.init();this.SL3.init();var A=this.pan.length;while(--A>-1){this.pan[A]=0;}this.eg.init();this.lfo.init();this.lfo.AM=0;this.lfo.PM=0;};}var b=(function(){var z={};z.CH=[new m(1),new m(2),new m(3),new m(4),new m(5),new m(6)];z.dacen=0;z.dacout=0;z.OPN=new v();z.init=function(){var A=z.CH.length;while(--A>-1){z.CH[A].init();}z.dacen=0;z.dacout=0;z.OPN.init();};return z;})();function l(A,z){if(z<0||z>=A.SLOT.length){throw new RangeError("FM_KEYON_CSM - out of range");}if(!A.SLOT[z].key&&!b.OPN.SL3.key_csm){A.SLOT[z].phase=0;A.SLOT[z].ssgn=0;if((A.SLOT[z].rate.ar+A.SLOT[z].rate.ksr)<94){A.SLOT[z].state=A.SLOT[z].volume<=a.MIN_ATT_INDEX?(A.SLOT[z].sl===a.MIN_ATT_INDEX?o.SUS:o.DEC):o.ATT;}else{A.SLOT[z].volume=a.MIN_ATT_INDEX;A.SLOT[z].state=A.SLOT[z].sl===a.MIN_ATT_INDEX?o.SUS:o.DEC;}if((A.SLOT[z].ssg&8)&&A.SLOT[z].ssgn^(A.SLOT[z].ssg&4)){A.SLOT[z].vol_out=(((512-A.SLOT[z].volume)|0)&a.MAX_ATT_INDEX)+A.SLOT[z].tl;}else{A.SLOT[z].vol_out=((A.SLOT[z].volume+A.SLOT[z].tl)|0);}}}function i(A,z){if(z<0||z>=A.SLOT.length){throw new RangeError("FM_KEYOFF_CSM - out of range");}if(!A.SLOT[z].key){if(A.SLOT[z].state>o.REL){A.SLOT[z].state=o.REL;if(A.SLOT[z].ssg&8){if(A.SLOT[z].ssgn^(A.SLOT[z].ssg&4)){A.SLOT[z].volume=512-A.SLOT[z].volume;}if(A.SLOT[z].volume>=512){A.SLOT[z].volume=a.MAX_ATT_INDEX;A.SLOT[z].state=o.OFF;}A.SLOT[z].vol_out=((SLOT.volume+SLOT.tl)|0);}}}}function n(z){l(z,c[0]);l(z,c[1]);l(z,c[2]);l(z,c[3]);b.OPN.SL3.key_csm=1;}function t(){if(b.OPN.ST.mode&1){if((b.OPN.ST.TAC-=b.OPN.ST.TimerBase)<=0){if(b.OPN.ST.mode&4){b.OPN.ST.status|=1;}if(b.OPN.ST.TAL){b.OPN.ST.TAC+=b.OPN.ST.TAL;}else{b.OPN.ST.TAC=b.OPN.ST.TAL;}if((b.OPN.ST.mode&192)===128){n(b.CH[2]);}}}}function r(z){if(b.OPN.ST.mode&2){if((b.OPN.ST.TBC-=(b.OPN.ST.TimerBase*z))<=0){if(b.OPN.ST.mode&8){b.OPN.ST.status|=2;}if(b.OPN.ST.TBL){b.OPN.ST.TBC+=b.OPN.ST.TBL;}else{b.OPN.ST.TBC=b.OPN.ST.TBL;}}}}function k(z){if((b.OPN.ST.mode^z)&192){b.CH[2].SLOT[c[0]].Incr=-1;if(((z&192)!==128)&&b.OPN.SL3.key_csm){i(b.CH[2]._SLOT[0]);i(b.CH[2]._SLOT[1]);i(b.CH[2]._SLOT[2]);i(b.CH[2]._SLOT[3]);b.OPN.SL3.key_csm=0;}}if((z&1)&&!(b.OPN.ST.mode&1)){b.OPN.ST.TAC=b.OPN.ST.TAL;}if((z&2)&&!(b.OPN.ST.mode&2)){b.OPN.ST.TBC=b.OPN.ST.TBL;}b.OPN.ST.status&=~z>>4;b.OPN.ST.mode=z;}b.OPN.advance_lfo=function(){if(this.lfo.timer_overflow){this.lfo.timer+=this.lfo.timer_add;while(this.lfo.timer>=this.lfo.timer_overflow){this.lfo.timer-=this.lfo.timer_overflow;this.lfo.cnt=(this.lfo.cnt+1)&127;if(this.lfo.cnt<64){this.lfo.AM=this.lfo.cnt*2;}else{this.lfo.AM=126-((this.lfo.cnt&63)*2);}this.lfo.PM=this.lfo.cnt>>2;}}};h.WriteMode=function(A,z){switch(A){case 33:break;case 34:if(z&8){if(!b.OPN.lfo.timer_overflow){b.OPN.lfo.cnt=0;b.OPN.lfo.timer=0;b.OPN.lfo.AM=0;b.OPN.lfo.PM=0;}b.OPN.lfo.timer_overflow=d.samples_per_step[z&7]<<e.LFO_SH;}else{b.OPN.lfo.timer_overflow=0;}break;case 36:b.OPN.ST.TA=(b.OPN.ST.TA&3)|(((z)|0)<<2);b.OPN.ST.TAL=(1024-b.OPN.ST.TA)<<e.TIMER_SH;break;case 37:b.OPN.ST.TA=(b.OPN.ST.TA&1020)|(z&3);b.OPN.ST.TAL=(1024-b.OPN.ST.TA)<<e.TIMER_SH;break;case 38:b.OPN.ST.TB=z;b.OPN.ST.TBL=(256-b.OPN.ST.TB)<<(e.TIMER_SH+4);break;case 39:k(z);break;case 40:var B=z&3;if(B===3){break;}if(z&4){B+=3;}if(z&16){b.CH[B].SLOT[c[0]].keyOn();}else{b.CH[B].SLOT[c[0]].keyOff();}if(z&32){b.CH[B].SLOT[c[1]].keyOn();}else{b.CH[B].SLOT[c[1]].keyOff();}if(z&64){b.CH[B].SLOT[c[2]].keyOn();}else{b.CH[B].SLOT[c[2]].keyOff();}if(z&128){b.CH[B].SLOT[c[3]].keyOn();}else{b.CH[B].SLOT[c[3]].keyOff();}break;}};h.WriteReg=function(E,B){var F=h.CHAN(E),D=h.SLOT(E);if(F>=3){throw new Error("OPN_Write - unsupported channel");}if(E&256){F+=3;}switch(E&240){case 48:b.CH[F].set_det_mul(D,B);break;case 64:b.CH[F].SLOT[D].set_tl(B);break;case 80:b.CH[F].set_ar_ksr(D,B);break;case 96:b.CH[F].SLOT[D].set_dr(B);b.CH[F].SLOT[D].AMmask=B&128?~0:0;break;case 112:b.CH[F].SLOT[D].set_sr(B);break;case 128:b.CH[F].SLOT[D].set_sl_rr(B);break;case 144:b.CH[F].SLOT[D].ssg=B&15;if(b.CH[F].SLOT[D].state>o.REL){if((b.CH[F].SLOT[D].ssg&8)&&(b.CH[F].SLOT[D].ssgn^(b.CH[F].SLOT[D].ssg&4))){b.CH[F].SLOT[D].vol_out=(((512-b.CH[F].SLOT[D].volume)|0)&a.MAX_ATT_INDEX)+b.CH[F].SLOT[D].tl;}else{b.CH[F].SLOT[D].vol_out=((b.CH[F].SLOT[D].volume)|0)+b.CH[F].SLOT[D].tl;}}break;case 160:var C,A;switch(D){case 0:C=((((b.OPN.ST.fn_h)|0)&7)<<8)+B;A=b.OPN.ST.fn_h>>3;b.CH[F].kcode=(A<<2)|h.fktable[C>>7];b.CH[F].fc=b.OPN.fn.table[C*2]>>(7-A);b.CH[F].block_fnum=(A<<11)|C;b.CH[F].SLOT[c[0]].Incr=-1;break;case 1:b.OPN.ST.fn_h=B&63;break;case 2:if(E<256){C=((((b.OPN.SL3.fn_h)|0)&7)<<8)+B;A=b.OPN.SL3.fn_h>>3;b.OPN.SL3.kcode[F]=(A<<2)|h.fktable[C>>7];b.OPN.SL3.fc[F]=b.OPN.fn.table[C*2]>>(7-A);b.OPN.SL3.block_fnum[F]=(A<<11)|C;b.CH[2].SLOT[c[0]].Incr=-1;}break;case 3:if(E<256){b.OPN.SL3.fn_h=B&63;}break;}break;case 176:switch(D){case 0:var z=(B>>3)&7;b.CH[F].ALGO=B&7;b.CH[F].FB=z?z+6:0;b.CH[F].setup_connection(F);break;case 1:b.CH[F].pms=(B&7)*32;b.CH[F].ams=d.ams_depth_shift[(B>>4)&3];b.OPN.pan[F*2]=B&128?4294967295:0;b.OPN.pan[F*2+1]=B&64?4294967295:0;break;}break;}};function y(z){var A,C;var B;C=-1;while(++C<=3){A=-1;while(++A<=31){B=o.dt_tab[C*32+A]*z*(1<<(e.FREQ_SH-10));b.OPN.ST.dt_tab[C][A]=((B)|0);b.OPN.ST.dt_tab[C+4][A]=-b.OPN.ST.dt_tab[C][A];}}A=4096;while(--A>-1){b.OPN.fn.table[A]=((A*32*z*(1<<(e.FREQ_SH-10)|0)));}b.OPN.fn.max=((131072*z*(1<<(e.FREQ_SH-10)|0)));}h.SetPres=function(A){if(x.debug){console.log("OPN::SetPrescaler - clock="+b.OPN.ST.clock+" rate="+b.OPN.ST.rate+" prescale="+A);}var z=b.OPN.ST.clock/b.OPN.ST.rate/A;if(x.debug){console.log("OPN::SetPrescaler - EG shift="+e.EG_SH+", freq ratio="+z.toFixed(4)+(x.hq_fm?", but HQ is on so 1.0":""));}if(x.hq_fm){z=1;}b.OPN.eg.timer_add=(((1<<e.EG_SH)|0)*z);b.OPN.eg.timer_overflow=3*(1<<e.EG_SH);b.OPN.lfo.timer_add=(((1<<e.LFO_SH)|0)*z);b.OPN.ST.TimerBase=(((1<<e.TIMER_SH)|0)*z);y(z);};function j(){var P,E;var I;var H,M;var O=~((1<<(14-x.dac_bits))-1);var L=(a.STEP/4),T=L/8,J=1<<16;var R=2*p.RES_LEN,N,B;E=-1;while(++E<p.RES_LEN){M=Math.floor(J/Math.pow(2,(E+1)*T));I=((M)|0)>>4;if(I&1){I=(I>>1)+1;}else{I=I>>1;}I<<=2;B=E*2;p.tab[B+0]=I&O;p.tab[B+1]=-p.tab[B+0]&O;P=0;while(++P<13){N=P*R;p.tab[B+0+N]=(p.tab[B+0]>>P)&O;p.tab[B+1+N]=-p.tab[B+0+N]&O;}}var G=Math.PI/e.SIN_LEN,S=8/Math.log(2);P=-1;while(++P<e.SIN_LEN){M=Math.sin((P*2+1)*G);if(M>0){H=Math.log(1/M)*S;}else{H=Math.log(-1/M)*S;}H=H/L;I=((2*H)|0);if(I&1){I=(I>>1)+1;}else{I=I>>1;}e.sin[P]=I*2+(M>=0?0:1);}var F,K,D;var C,A,z;var Q=32*8;P=-1;while(++P<8){C=P;F=-1;while(++F<128){D=-1;while(++D<8){K=0;z=-1;while(++z<7){if(F&(1<<z)){A=z*8;K+=d.pm_output[A+C][D];}d.pm_table[F*Q+P*32+D+0]=K;d.pm_table[F*Q+P*32+(D^7)+8]=K;d.pm_table[F*Q+P*32+D+16]=-K;d.pm_table[F*Q+P*32+(D^7)+24]=-K;}}}}}this.init=function(z,A){b.init();j();b.OPN.ST.clock=z;b.OPN.ST.rate=A;h.SetPres(6*24);};this.reset=function(){var z;b.OPN.eg.timer=0;b.OPN.eg.cnt=0;b.OPN.lfo.timer_overflow=0;b.OPN.lfo.timer=0;b.OPN.lfo.cnt=0;b.OPN.lfo.AM=0;b.OPN.lfo.PM=0;b.OPN.ST.TAC=0;b.OPN.ST.TBC=0;b.OPN.SL3.key_csm=0;b.dacen=0;b.dacout=0;k(48);b.OPN.ST.TB=0;b.OPN.ST.TBL=256<<(e.TIMER_SH+4);b.OPN.ST.TA=0;b.OPN.ST.TAL=1024<<e.TIMER_SH;z=b.CH.length;while(--z>-1){b.CH[z].reset();}z=182+1;while(--z>=180){h.WriteReg(z,192);h.WriteReg(z|256,192);}z=178+1;while(--z>=48){h.WriteReg(z,0);h.WriteReg(z|256,0);}};this.write=function(z,A){A&=255;b.OPN.ST.address=z&511;var B=b.OPN.ST.address;switch(B&496){case 32:switch(B){case 42:b.dacout=(((A)|0)&128)<<6;break;case 43:b.dacen=A&128;break;default:h.WriteMode(B,A);break;}break;default:h.WriteReg(B,A);}};this.read=function(){return b.OPN.ST.status&255;};this.update=function(D){if(x.debug){console.log("==== YM::update("+D+") - start...");}var C;var z=0,B=0;var A=[[],[]];b.CH[0].refresh_fc_eg();b.CH[1].refresh_fc_eg();if(!(b.OPN.ST.mode&192)){b.CH[2].refresh_fc_eg();}else{if(b.CH[2].SLOT[c[0]].Incr===-1){b.CH[2].SLOT[c[0]].refresh_fc_eg(b.OPN.SL3.fc[1],b.OPN.SL3.kcode[1]);b.CH[2].SLOT[c[1]].refresh_fc_eg(b.OPN.SL3.fc[2],b.OPN.SL3.kcode[2]);b.CH[2].SLOT[c[2]].refresh_fc_eg(b.OPN.SL3.fc[0],b.OPN.SL3.kcode[0]);b.CH[2].SLOT[c[3]].refresh_fc_eg(b.CH[2].fc,b.CH[2].kcode);}}b.CH[3].refresh_fc_eg();b.CH[4].refresh_fc_eg();b.CH[5].refresh_fc_eg();if(x.debug){console.log("YM::update - buffering...");}C=D;while(--C>-1){e.out_fm[0]=0;e.out_fm[1]=0;e.out_fm[2]=0;e.out_fm[3]=0;e.out_fm[4]=0;e.out_fm[5]=0;b.CH[0].update_ssg_eg();b.CH[1].update_ssg_eg();b.CH[2].update_ssg_eg();b.CH[3].update_ssg_eg();b.CH[4].update_ssg_eg();b.CH[5].update_ssg_eg();b.CH[0].calculate();b.CH[1].calculate();b.CH[2].calculate();b.CH[3].calculate();b.CH[4].calculate();if(!b.dacen){b.CH[5].calculate();}else{e.out_fm[5]=b.dacout;}b.OPN.advance_lfo();b.OPN.eg.timer+=b.OPN.eg.timer_add;while(b.OPN.eg.timer>=b.OPN.eg.timer_overflow){b.OPN.eg.timer-=b.OPN.eg.timer_overflow;++b.OPN.eg.cnt;b.CH[0].advance_eg_channel();b.CH[1].advance_eg_channel();b.CH[2].advance_eg_channel();b.CH[3].advance_eg_channel();b.CH[4].advance_eg_channel();b.CH[5].advance_eg_channel();}e.out_fm[0]=e.limit(e.out_fm[0],-8192,8192);e.out_fm[1]=e.limit(e.out_fm[1],-8192,8192);e.out_fm[2]=e.limit(e.out_fm[2],-8192,8192);e.out_fm[3]=e.limit(e.out_fm[3],-8192,8192);e.out_fm[4]=e.limit(e.out_fm[4],-8192,8192);e.out_fm[5]=e.limit(e.out_fm[5],-8192,8192);z=(e.out_fm[0]&b.OPN.pan[0])+(e.out_fm[1]&b.OPN.pan[2])+(e.out_fm[2]&b.OPN.pan[4])+(e.out_fm[3]&b.OPN.pan[6])+(e.out_fm[4]&b.OPN.pan[8])+(e.out_fm[5]&b.OPN.pan[10])+0;B=(e.out_fm[0]&b.OPN.pan[1])+(e.out_fm[1]&b.OPN.pan[3])+(e.out_fm[2]&b.OPN.pan[5])+(e.out_fm[3]&b.OPN.pan[7])+(e.out_fm[4]&b.OPN.pan[9])+(e.out_fm[5]&b.OPN.pan[11])+0;A[0].push(z);A[1].push(B);b.OPN.SL3.key_csm<<=1;t();if(b.OPN.SL3.key_csm&2){i(b.CH[2],c[0]);i(b.CH[2],c[1]);i(b.CH[2],c[2]);i(b.CH[2],c[3]);b.OPN.SL3.key_csm=0;}}if(x.debug){console.log("YM::update - end buffering...");}r(D);if(x.debug){console.log("==== YM::update("+D+") - end...");}return A;};this.getContext=function(){return b;};this.getContextSize=function(){return 1;};this.restore=function(z){};this.load=function(z){};this.save=function(z){};}