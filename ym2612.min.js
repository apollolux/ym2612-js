function YM2612(){if(!this instanceof YM2612)return new YM2612;this.version=257;this.start=0;this.count=0;this.chip=null}(function(e){"use strict";function c(){function e(){this.ar=0;this.d1r=0;this.d2r=0;this.rr=0;this.ksr=0;this.mul=1;this.init=function(){this.ar=0;this.d1r=0;this.d2r=0;this.rr=0;this.ksr=0;this.mul=1}}function t(){this.ar=0;this.d1r=0;this.d2r=0;this.rr=0;this.init=function(){this.ar=0;this.d1r=0;this.d2r=0;this.rr=0}}this.DT=-1;this.KSR=0;this.rate=new e;this.phase=0;this.Incr=0;this.state=0;this.tl=0;this.volume=0;this.sl=0;this.vol_out=0;this.eg={sh:new t,sel:new t,init:function(){this.sh.init();this.sel.init()}};this.ssg=0;this.ssgn=0;this.key=0;this.AMmask=0;this.reset=function(){this.Incr=-1;this.key=0;this.phase=0;this.ssgn=0;this.state=i.OFF;this.volume=r.MAX_ATT_INDEX;this.vol_out=r.MAX_ATT_INDEX}}function h(){this.SLOT=[new c,new c,new c,new c];this.ALGO=0;this.FB=0;this.op1_out=[0,0];this.connect=["x","x","x","x"];this.mem={connect:"mem",value:0};this.pms=0;this.ams=0;this.fc=0;this.kcode=0;this.block_fnum=0;this.out=0;this.canCSM=0;this.canDAC=0;this.muted=0;this.pan=[0,0];this.reset=function(){this.mem.value=0,this.op1_out[0]=0,this.op1_out[1]=0;var e=this.SLOT.length;while(--e>-1)this.SLOT[e].reset()}}function p(e,t){this.address=0;this.status=0;this.mode=0;this.fn_h=0;this.TA=0;this.TAL=0;this.TAC=0;this.TB=0;this.TBL=0;this.TBC=0;this.dt_tab=[new Array(32),new Array(32),new Array(32),new Array(32),new Array(32),new Array(32),new Array(32),new Array(32)];this.clock=e||7670448;this.rate=t||44100}function d(){this.fc=[0,0,0];this.fn_h=0;this.kcode=[0,0,0];this.block_fnum=[0,0,0];this.key_csm=0}function v(e,t){function n(){this.cnt=0;this.timer=0;this.timer_add=0;this.timer_overflow=0;this.init=function(){this.cnt=0;this.timer=0;this.timer_add=0;this.timer_overflow=0}}this.ST=new p(e,t);this.SL3=new d;this.eg=new n;this.lfo=new n;this.lfo.AM=0;this.lfo.PM=0;this.fn={table:[],max:0}}function m(e,t){this.CH=[new h,new h,new h,new h,new h,new h];this.CH[2].canCSM=1;this.CH[5].canDAC=1;this.dacen=0;this.dacout=0;this.OPN=new v(e,t)}function g(e){if((e.OPN.ST.mode&1)>0){--e.OPN.ST.TAC;if(e.OPN.ST.TAC<=0){if((e.OPN.ST.mode&4)>0)e.OPN.ST.status|=1;e.OPN.ST.TAC=e.OPN.ST.TAL;if((e.OPN.ST.mode&192)==128)e.CH[2].keyControlCSM()}}}function y(e,t){if((e.OPN.ST.mode&2)>0){e.OPN.ST.TBC-=t;if(e.OPN.ST.TBC<=0){if((e.OPN.ST.mode&8)>0)e.OPN.ST.status|=2;if(e.OPN.ST.TBL)e.OPN.ST.TBC+=e.OPN.ST.TBL;else e.OPN.ST.TBC=e.OPN.ST.TBL}}}function b(e,t){if(((e.OPN.ST.mode^t)&192)>0){e.CH[2].SLOT[l[0]].Incr=-1;if((t&192)!==128&&e.OPN.SL3.key_csm){e.CH[2].keyOffCSM(l[0]);e.CH[2].keyOffCSM(l[1]);e.CH[2].keyOffCSM(l[2]);e.CH[2].keyOffCSM(l[3]);e.OPN.SL3.key_csm=0}}if(t&1&&!(e.OPN.ST.mode&1))e.OPN.ST.TAC=e.OPN.ST.TAL;if(t&2&&!(e.OPN.ST.mode&2))e.OPN.ST.TBC=e.OPN.ST.TBL;e.OPN.ST.status&=~t>>4;e.OPN.ST.mode=t}function w(e){if(e.OPN.lfo.timer_overflow){++e.OPN.lfo.timer;if(e.OPN.lfo.timer>=e.OPN.lfo.timer_overflow){e.OPN.lfo.timer=0;e.OPN.lfo.cnt=e.OPN.lfo.cnt+1&127;if(e.OPN.lfo.cnt<64)e.OPN.lfo.AM=(e.OPN.lfo.cnt^63)<<1;else e.OPN.lfo.AM=(e.OPN.lfo.cnt&63)<<1;e.OPN.lfo.PM=e.OPN.lfo.cnt>>2}}}function E(e,t){var n=e.CH.length;while(--n>-1)e.CH[n].advance_eg(t)}function S(e){var t=e.CH.length;while(--t>-1)e.CH[t].update_ssg_eg()}function x(e,t,r,i){var s=(t<<3)+n.sin[(i?e+r>>o.BITS:(e>>o.BITS)+(r>>1))&o.MASK];if(s>=u.TAB_LEN)return 0;return u.tab[s]}function T(e,t){if(t>e.CH.length)t=e.CH.length;while(--t>-1)e.CH[t].reset()}function N(e){if(t.debug)console.log("init_tables",e.CH.length);var i,s,a;var l;var c,h;var p,d;var v=r.STEP/32,m=1<<16,g=u.RES_LEN<<1;for(a=0;a<u.RES_LEN;++a){h=m/Math.pow(2,(a+1)*v);l=(h|0)>>4;if(l&1)l=(l>>1)+1;else l=l>>1;l<<=2;d=a<<1;u.tab[d+0]=l;u.tab[d+1]=-l;for(s=1;s<13;++s){p=d+0+s*g|0;u.tab[p]=u.tab[d]>>s;u.tab[p+1]=-u.tab[p]}}p=Math.PI/o.LEN,d=8/Math.log(2),v=2*4/r.STEP;for(s=0;s<o.LEN;++s){h=Math.sin(((s<<1)+1)*p);if(h>0)c=Math.log(1/h)*d;else c=Math.log(-1/h)*d;l=c*v|0;if(l&1)l=(l>>1)+1;else l=l>>1;n.sin[s]=(l<<1)+(h>=0?0:1)}for(s=0;s<8;++s){for(l=0;l<128;++l){for(a=0;a<8;++a){d=0;for(c=0;c<7;++c){if((l&1<<c)>0){d+=f.pm_output[(c<<3)+s][a]}}i=(l<<8)+(s<<5);f.pm_table[i+a+0]=d;f.pm_table[i+(a^7)+8]=d;f.pm_table[i+a+16]=-d;f.pm_table[i+(a^7)+24]=-d}}}}var t={hq_fm:0,dac_bits:8,maxcalc:0,debug:0,debugLocal:0,debugArr:[],strict:0};var n={FREQ_SH:16,EG_SH:16,LFO_SH:24,TIMER_SH:16};n.FREQ_MASK=(1<<n.FREQ_SH)-1;var r={BITS:10,MIN_ATT_INDEX:0};r.LEN=1<<r.BITS;r.STEP=128/r.LEN;r.MAX_ATT_INDEX=r.LEN-1;var i={ATT:4,DEC:3,SUS:2,REL:1,OFF:0};var s={BITS:17};s.LEN=1<<s.BITS;s.MASK=s.LEN-1;var o={BITS:10};o.LEN=1<<o.BITS;o.MASK=o.LEN-1;var u={BITS:14};u.RES_LEN=256;u.TAB_LEN=13*2*u.RES_LEN;u.tab=new Array(u.TAB_LEN);r.QUIET=u.TAB_LEN>>3;n.sin=new Array(o.LEN);n.sl=function(){var e=function(e){return e*4/r.STEP|0};return[e(0),e(1),e(2),e(3),e(4),e(5),e(6),e(7),e(8),e(9),e(10),e(11),e(12),e(13),e(14),e(31)]}();i.RATE_STEPS=8;i.inc=[0,1,0,1,0,1,0,1,0,1,0,1,1,1,0,1,0,1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1,1,1,2,1,2,1,2,1,2,1,2,1,2,2,2,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,4,2,2,2,4,2,4,2,4,2,4,2,4,2,4,4,4,2,4,4,4,4,4,4,4,4,4,4,4,4,4,4,8,4,4,4,8,4,8,4,8,4,8,4,8,4,8,8,8,4,8,8,8,8,8,8,8,8,8,8,8,16,16,16,16,16,16,16,16,0,0,0,0,0,0,0,0];i.rate_select=function(){var e=function(e){return e*i.RATE_STEPS|0};return[e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(18),e(0),e(0),e(0),e(0),e(2),e(2),e(0),e(1),e(2),e(3),e(0),e(1),e(2),e(3),e(0),e(1),e(2),e(3),e(0),e(1),e(2),e(3),e(0),e(1),e(2),e(3),e(0),e(1),e(2),e(3),e(0),e(1),e(2),e(3),e(0),e(1),e(2),e(3),e(0),e(1),e(2),e(3),e(0),e(1),e(2),e(3),e(4),e(5),e(6),e(7),e(8),e(9),e(10),e(11),e(12),e(13),e(14),e(15),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16),e(16)]}();i.rate_shift=function(){var e=function(e){return e|0};return[e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(11),e(10),e(10),e(10),e(10),e(9),e(9),e(9),e(9),e(8),e(8),e(8),e(8),e(7),e(7),e(7),e(7),e(6),e(6),e(6),e(6),e(5),e(5),e(5),e(5),e(4),e(4),e(4),e(4),e(3),e(3),e(3),e(3),e(2),e(2),e(2),e(2),e(1),e(1),e(1),e(1),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0),e(0)]}();s.tab=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,2,2,2,2,2,3,3,3,4,4,4,5,5,6,6,7,8,8,8,8,1,1,1,1,2,2,2,2,2,3,3,3,4,4,4,5,5,6,6,7,8,8,9,10,11,12,13,14,16,16,16,16,2,2,2,2,2,3,3,3,4,4,4,5,5,6,6,7,8,8,9,10,11,12,13,14,16,17,19,20,22,22,22,22];var a={fktable:[0,0,0,0,0,0,0,1,2,3,3,3,3,3,3,3]};var f={samples_per_step:[108,77,71,67,62,44,8,5],ams_depth_shift:[8,3,1,0],pm_output:[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,1,1,1,1],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,1,1,1,1],[0,0,1,1,2,2,2,3],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1],[0,0,0,0,1,1,1,1],[0,0,1,1,2,2,2,3],[0,0,2,3,4,4,5,6],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,1],[0,0,0,0,1,1,1,1],[0,0,0,1,1,1,1,2],[0,0,1,1,2,2,2,3],[0,0,2,3,4,4,5,6],[0,0,4,6,8,8,10,12],[0,0,0,0,0,0,0,0],[0,0,0,0,1,1,1,1],[0,0,0,1,1,1,2,2],[0,0,1,1,2,2,3,3],[0,0,1,2,2,2,3,4],[0,0,2,3,4,4,5,6],[0,0,4,6,8,8,10,12],[0,0,8,12,16,16,20,24],[0,0,0,0,0,0,0,0],[0,0,0,0,2,2,2,2],[0,0,0,2,2,2,4,4],[0,0,2,2,4,4,6,6],[0,0,2,4,4,4,6,8],[0,0,4,6,8,8,10,12],[0,0,8,12,16,16,20,24],[0,0,16,24,32,32,40,48],[0,0,0,0,0,0,0,0],[0,0,0,0,4,4,4,4],[0,0,0,4,4,4,8,8],[0,0,4,4,8,8,12,12],[0,0,4,8,8,8,12,16],[0,0,8,12,16,16,20,24],[0,0,16,24,32,32,40,48],[0,0,32,48,64,64,80,96]],pm_table:new Array(128*8*32)};a.CHAN=function(e){return e&3};a.SLOT=function(e){return e>>2&3};var l=[0,2,1,3];n.m2=0;n.c1=0;n.c2=0;n.mem=0;n.bitmask=0;c.prototype.keyOn=function(e,t){if(!this.key&&!e.OPN.SL3.key_csm){this.phase=0;this.ssgn=0;if(this.rate.ar+this.rate.ksr<94)this.state=this.volume<=r.MIN_ATT_INDEX?this.sl===r.MIN_ATT_INDEX?i.SUS:i.DEC:i.ATT;else{this.volume=r.MIN_ATT_INDEX;this.state=this.rate.sl===r.MIN_ATT_INDEX?i.SUS:i.DEC}if((this.ssg&8)>0&&(this.ssgn^this.ssg&4)>0)this.vol_out=this.tl+(512-this.volume&r.MAX_ATT_INDEX);else this.vol_out=this.tl+(this.volume|0)}if(!t)this.key=1};h.prototype.keyOn=function(e,t){this.SLOT[t].keyOn(e,0)};c.prototype.keyOff=function(e,t){if(t&&!this.key||!t&&this.key&&!e.OPN.SL3.key_csm){if(this.state>i.REL){this.state=i.REL;if((this.ssg&8)>0){if((this.ssgn^this.ssg&4)>0)this.volume=512-this.volume|0;if(this.volume>=512){this.volume=r.MAX_ATT_INDEX;this.state=i.OFF}this.vol_out=this.tl+(this.volume|0)}}}if(!t)this.key=0};h.prototype.keyOff=function(e,t){this.SLOT[t].keyOff(e,0)};h.prototype.keyOnCSM=function(e,t){this.SLOT[t].keyOn(e,1)};h.prototype.keyOffCSM=function(e,t){this.SLOT[t].keyOff(e,1)};h.prototype.keyControlCSM=function(e){this.keyOnCSM(l[0]);this.keyOnCSM(l[1]);this.keyOnCSM(l[2]);this.keyOnCSM(l[3]);e.OPN.SL3.key_csm=1};h.prototype.setupConnection=function(){var e="out";var n=1,r=3,i=2;switch(this.ALGO){case 0:this.connect[n]="c1";this.connect[i]="mem";this.connect[r]="c2";this.mem.connect="m2";break;case 1:this.connect[n]="mem";this.connect[i]="mem";this.connect[r]="c2";this.mem.connect="m2";break;case 2:this.connect[n]="c2";this.connect[i]="mem";this.connect[r]="c2";this.mem.connect="m2";break;case 3:this.connect[n]="c1";this.connect[i]="mem";this.connect[r]="c2";this.mem.connect="c2";break;case 4:this.connect[n]="c1";this.connect[i]=e;this.connect[r]="c2";this.mem.connect="mem";break;case 5:this.connect[n]="x";this.connect[i]=e;this.connect[r]=e;this.mem.connect="m2";break;case 6:this.connect[n]="c1";this.connect[i]=e;this.connect[r]=e;this.mem.connect="mem";break;case 7:this.connect[n]=e;this.connect[i]=e;this.connect[r]=e;this.mem.connect="mem";break;default:if(t.strict)throw new Error("CH::setup_connection - unsupported algorithm ("+this.ALGO+")");else break}this.connect[3]=e};c.prototype.set_det_mul=function(e,t){this.rate.mul=(t&15)>0?(t&15)<<1:1;this.DT=t>>4&7};h.prototype.set_det_mul=function(e,t,n){this.SLOT[t].set_det_mul(e,n);this.SLOT[l[0]].Incr=-1};c.prototype.set_tl=function(e){this.tl=(e&127)<<r.BITS-7;if((this.ssg&8)>0&&((this.ssgn^this.ssg&4)>0?1:0)&&this.state>i.REL)this.vol_out=this.tl+((512-this.volume|0)&r.MAX_ATT_INDEX);else this.vol_out=this.tl+(this.volume|0)};h.prototype.set_tl=function(e,t){this.SLOT[e].set_tl(t)};c.prototype.set_ar_ksr=function(e){var t=this.KSR;this.rate.ar=(e&31)>0?32+((e&31)<<1):0;this.KSR=3-(e>>6);if(this.rate.ar+this.rate.ksr<32+62){var n=this.rate.ar+this.rate.ksr|0;this.eg.sh.ar=i.rate_shift[n];this.eg.sel.ar=i.rate_select[n]}else{this.eg.sh.ar=0;this.eg.sel.ar=18*i.RATE_STEPS}return this.KSR!==t};h.prototype.set_ar_ksr=function(e,t){if(this.SLOT[e].set_ar_ksr(t))this.SLOT[l[0]].Incr=-1};c.prototype.set_dr=function(e){this.rate.d1r=(e&31)>0?32+((e&31)<<1):0;var t=this.rate.d1r+this.rate.ksr|0;this.eg.sh.d1r=i.rate_shift[t];this.eg.sel.d1r=i.rate_select[t]};h.prototype.set_dr=function(e,t){this.SLOT[e].set_dr(t)};c.prototype.set_sr=function(e){this.rate.d2r=(e&31)>0?32+((e&31)<<1):0;var t=this.rate.d2r+this.rate.ksr|0;this.eg.sh.d2r=i.rate_shift[t];this.eg.sh.d2r=i.rate_select[t]};h.prototype.set_sr=function(e,t){this.SLOT[e].set_sr(t)};c.prototype.set_sl_rr=function(e){this.sl=n.sl[e>>4&15];if(this.state===i.DEC&&this.volume>=(this.sl|0))this.state=i.SUS;this.rate.rr=34+((e&15)<<2);var t=this.rate.rr+this.rate.ksr|0;this.eg.sh.rr=i.rate_shift[t];this.eg.sel.rr=i.rate_select[t]};h.prototype.set_sl_rr=function(e,t){this.SLOT[e].set_sl_rr(t)};c.prototype.advance_eg=function(e){switch(this.state){case i.ATT:if(!(e&(1<<this.eg.sh.ar)-1)){this.volume+=~this.volume*i.inc[this.eg.sel.ar+(e>>this.eg.sh.ar&7)]>>4;if(this.volume<=r.MIN_ATT_INDEX){this.volume=r.MIN_ATT_INDEX;this.state=(this.sl|0)===r.MIN_ATT_INDEX?i.SUS:i.DEC}if((this.ssg&8)>0&&(this.ssgn^this.ssg&4)>0)this.vol_out=this.tl+((512-this.volume|0)&r.MAX_ATT_INDEX);else this.vol_out=this.tl+(this.volume|0)}break;case i.DEC:if(!(e&(1<<this.eg.sh.d1r)-1)){if((this.ssg&8)>0){if(this.volume<512){this.volume+=i.inc[this.eg.sel.d1r+(e>>this.eg.sh.d1r&7)]<<2;if((this.ssgn^this.ssg&4)>0)this.vol_out=this.tl+((512-this.volume|0)&r.MAX_ATT_INDEX);else this.vol_out=this.tl+(this.volume|0)}}else{this.volume+=i.inc[this.eg.sel.d1r+(e>>this.eg.sh.d1r&7)];this.vol_out=this.tl+(this.volume|0)}if(this.volume>=(this.sl|0))this.state=i.SUS}break;case i.SUS:if(!(e&(1<<this.eg.sh.d2r)-1)){if((this.ssg&8)>0){if(this.volume<512){this.volume+=i.inc[this.eg.sel.d2r+(e>>this.eg.sh.d2r&7)]<<2;if((this.ssgn^this.ssg&4)>0)this.vol_out=this.tl+((512-this.volume|0)&r.MAX_ATT_INDEX);else this.vol_out=this.tl+(this.volume|0)}}else{this.volume+=i.inc[this.eg.sel.d2r+(e>>this.eg.sh.d2r&7)];if(this.volume>=r.MAX_ATT_INDEX)this.volume=r.MAX_ATT_INDEX;this.vol_out=this.tl+(this.volume|0)}}break;case i.REL:if(!(e&(1<<this.eg.sh.rr)-1)){if((this.ssg&8)>0){if(this.volume<512){this.volume+=i.inc[this.eg.sel.rr+(e>>this.eg.sh.rr&7)]<<2;if(this.volume>=512){this.volume=r.MAX_ATT_INDEX;this.state=i.OFF}}}else{this.volume+=i.inc[this.eg.sel.rr+(e>>this.eg.sh.rr&7)];if(this.volume>=r.MAX_ATT_INDEX){this.volume=r.MAX_ATT_INDEX;this.state=i.OFF}this.vol_out=this.tl+(this.volume|0)}}break;default:if(t.strict)throw new Error("FM_SLOT::advance_eg - unsupported state ("+this.state+")");else break}};h.prototype.advance_eg=function(e){var t=this.SLOT.length;while(--t>-1)this.SLOT[t].advance_eg(e)};c.prototype.update_ssg_eg=function(){if((this.ssg&8)>0&&this.volume>=512&&this.state>i.REL){if((this.ssg&1)>0){if((this.ssg&2)>0)this.ssgn=4;if(this.state!==i.ATT&&(this.ssgn^this.ssg&4)<=0)this.volume=r.MAX_ATT_INDEX}else{if((this.ssg&2)>0)this.ssgn^=4;else this.phase=0;if(this.state!==i.ATT){if(this.rate.ar+this.rate.ksr<94)this.state=this.volume<=r.MIN_ATT_INDEX?(this.sl|0)===r.MIN_ATT_INDEX?i.SUS:i.DEC:i.ATT;else{this.volume=r.MIN_ATT_INDEX;this.state=(this.sl|0)===r.MIN_ATT_INDEX?i.SUS:i.DEC}}}if((this.ssgn^this.ssg&4)>0)this.vol_out=this.tl+((512-this.volume|0)&r.MAX_ATT_INDEX);else this.vol_out=this.tl+this.volume}};h.prototype.update_ssg_eg=function(){var e=this.SLOT.length;while(--e>-1)this.SLOT[e].update_ssg_eg()};c.prototype.update_phase_lfo=function(e,n,r){var i=f.pm_table[((r&2032)>>4<<8)+n+e.OPN.lfo.PM];if(i){if(this.DT<0){console.log("FM_SLOT::update_phase_lfo - invalid DT",this.DT);if(t.strict)throw new Error("FM_SLOT::update_phase_lfo - invalid DT="+this.DT);else return}var o,u,l;r=i+(r<<1);o=(r&28672)>>12;r=r&4095;u=o<<2|a.fktable[r>>8];l=(r<<5>>7-o)+e.OPN.ST.dt_tab[this.DT][u]&s.MASK;this.phase+=l*this.rate.mul>>1}else this.phase+=this.Incr};h.prototype.update_phase_lfo=function(e){var t=this.pms,n=this.block_fnum;var r=this.SLOT.length;while(--r>-1)this.SLOT[r].update_phase_lfo(e,t,n)};c.prototype.refresh_fc_eg=function(e,n,r){if(this.DT<0){console.log("FM_SLOT::refresh_fc_eg - invalid DT",this.DT);if(t.strict)throw new Error("FM_SLOT::refresh_fc_eg - invalid DT="+this.DT);else return}if(t.debug>1)console.log("OPN.ST.dt_tab["+this.DT+"]["+r+"]",e.OPN.ST.dt_tab[this.DT][r]);n+=e.OPN.ST.dt_tab[this.DT][r];n&=s.MASK;this.Incr=n*this.rate.mul>>1;r=r>>this.KSR;if(this.rate.ksr!==r){this.rate.ksr=r;var o=this.rate.ar+r|0;if(o<32+62){this.eg.sh.ar=i.rate_shift[o];this.eg.sel.ar=i.rate_select[o]}else{this.eg.sh.ar=0;this.eg.sel.ar=18*i.RATE_STEPS}o=this.rate.d1r+r|0;this.eg.sh.d1r=i.rate_shift[o];this.eg.sel.d1r=i.rate_select[o];o=this.rate.d2r+r|0;this.eg.sh.d2r=i.rate_shift[o];this.eg.sel.d2r=i.rate_select[o];o=this.rate.rr+r|0;this.eg.sh.rr=i.rate_shift[o];this.eg.sel.rr=i.rate_select[o]}};h.prototype.refresh_fc_eg=function(e){if(this.SLOT[l[0]].Incr===-1){var n=this.fc,r=this.kcode;if(t.debug>1)console.log("FM_CH::refresh_fc_eg",n,r);var i=this.SLOT.length;while(--i>-1)this.SLOT[l[i]].refresh_fc_eg(e,n,r)}};c.prototype.calcVol=function(e){return this.vol_out+(e&this.AMmask)};h.prototype.calculate=function(e){var i="",s=t.debug>1&&t.maxcalc>0;var o=e.OPN.lfo.AM>>this.ams;if(this.muted)return;var u,a;var f,c=["x","c1","m2","c2"];n.m2=0;n.c1=0;n.c2=0;n.mem=0;n[this.mem.connect]=this.mem.value;f=0;u=this.SLOT[l[f]].calcVol(o);if(s)i+="[0]eg_out="+u+(u<r.QUIET?"":"(nope)");if(1){var h=this.op1_out[0]+this.op1_out[1]|0;this.op1_out[0]=this.op1_out[1];a=this.op1_out[0];if(s)i+=";connect[0]="+this.connect[f];if(this.connect[f]==="x")n.mem=a,n.c1=a,n.c2=a;else if(this.connect[f]==="out")this.out+=a;else n[this.connect[f]]+=a;if(u<r.QUIET){if(!this.FB)h=0;this.op1_out[1]=x(this.SLOT[l[f]].phase,u,h<<this.FB,1)}}f=2;u=this.SLOT[l[f]].calcVol(o);if(s)i+="; [2]eg_out="+u+(u<r.QUIET?"":"(nope)");if(u<r.QUIET){a=x(this.SLOT[l[f]].phase,u,n[c[f]],0);if(s)i+=";connect[2]="+this.connect[f];if(this.connect[f]==="x"){}else if(this.connect[f]==="out")this.out+=a;else n[this.connect[f]]+=a}f=1;u=this.SLOT[l[f]].calcVol(o);if(s)i+="; [1]eg_out="+u+(u<r.QUIET?"":"(nope)");if(u<r.QUIET){a=x(this.SLOT[l[f]].phase,u,n[c[f]],0);if(s)i+=";connect[1]="+this.connect[f];if(this.connect[f]==="x"){}else if(this.connect[f]==="out")this.out+=a;else n[this.connect[f]]+=a}f=3;u=this.SLOT[l[f]].calcVol(o);if(s)i+="; [3]eg_out="+u+(u<r.QUIET?"":"(nope)");if(u<r.QUIET){a=x(this.SLOT[l[f]].phase,u,n[c[f]],0);if(s)i+=";connect[3]="+this.connect[f];if(this.connect[f]==="x"){}else if(this.connect[f]==="out")this.out+=a;else n[this.connect[f]]+=a}this.mem.value=n.mem;if(this.pms){if((e.OPN.ST.mode&192)>0&&this.canCSM){this.SLOT[l[0]].update_phase_lfo(e,this.pms,e.OPN.SL3.block_fnum[1]);this.SLOT[l[1]].update_phase_lfo(e,this.pms,e.OPN.SL3.block_fnum[2]);this.SLOT[l[2]].update_phase_lfo(e,this.pms,e.OPN.SL3.block_fnum[0]);this.SLOT[l[3]].update_phase_lfo(e,this.pms,this.block_fnum)}else this.update_phase_lfo(e)}else{this.SLOT[l[0]].phase+=this.SLOT[l[0]].Incr;this.SLOT[l[1]].phase+=this.SLOT[l[1]].Incr;this.SLOT[l[2]].phase+=this.SLOT[l[2]].Incr;this.SLOT[l[3]].phase+=this.SLOT[l[3]].Incr}if(s)i+="; m2="+n.m2+";c1="+n.c1+";c2="+n.c2+";out="+this.out,console.log("FM_CH::calc",this.ALGO,i),--t.maxcalc};a.WriteMode=function(e,t,n){n=n&255;switch(t){case 33:break;case 34:if(n&8){e.OPN.lfo.timer_overflow=f.samples_per_step[n&7]}else{e.OPN.lfo.timer_overflow=0;e.OPN.lfo.timer=0;e.OPN.lfo.cnt=0;e.OPN.lfo.AM=126;e.OPN.lfo.PM=0}break;case 36:e.OPN.ST.TA=e.OPN.ST.TA&3|(n|0)<<2;e.OPN.ST.TAL=1024-e.OPN.ST.TA;break;case 37:e.OPN.ST.TA=e.OPN.ST.TA&1020|n&3;e.OPN.ST.TAL=1024-e.OPN.ST.TA;break;case 38:e.OPN.ST.TB=n;e.OPN.ST.TBL=256-n;break;case 39:b(e,n);break;case 40:var r=n&3;if(r===3)break;if(n&4)r+=3;(function(t){if(n&16)t.keyOn(e,l[0]);else t.keyOff(e,l[0]);if(n&32)t.keyOn(e,l[1]);else t.keyOff(e,l[1]);if(n&64)t.keyOn(e,l[2]);else t.keyOff(e,l[2]);if(n&128)t.keyOn(e,l[3]);else t.keyOff(e,l[3])})(e.CH[r]);break}};a.WriteReg=function(e,s,o){o=o&255;var u=a.CHAN(s),c=a.SLOT(s);if(u>=3){if(t.strict)throw new Error("OPN_Write - unsupported channel "+u+" or slot "+c+" from {$"+s.toString(16)+",$"+o.toString(16)+"}");else return}if(s>=256)u+=3;var h=l[c];switch(s&240){case 48:e.CH[u].set_det_mul(e,h,o);break;case 64:e.CH[u].set_tl(h,o);break;case 80:e.CH[u].set_ar_ksr(h,o);break;case 96:e.CH[u].set_dr(h,o);e.CH[u].SLOT[h].AMmask=(o&128)>0?~0:0;break;case 112:e.CH[u].set_sr(h,o);break;case 128:e.CH[u].set_sl_rr(h,o);break;case 144:e.CH[u].SLOT[h].ssg=o&15;if(e.CH[u].SLOT[h].state>i.REL){if((e.CH[u].SLOT[h].ssg&8)>0&&(e.CH[u].SLOT[h].ssgn^e.CH[u].SLOT[h].ssg&4)>0)e.CH[u].SLOT[h].vol_out=e.CH[u].SLOT[h].tl+((512-e.CH[u].SLOT[h].volume|0)&r.MAX_ATT_INDEX);else e.CH[u].SLOT[h].vol_out=e.CH[u].SLOT[h].tl+(e.CH[u].SLOT[h].volume|0)}break;case 160:var p,d;switch(c){case 0:p=((e.OPN.ST.fn_h&7)<<8)+o;d=e.OPN.ST.fn_h>>3&255;e.CH[u].kcode=d<<2|a.fktable[p>>7];e.CH[u].fc=p<<6>>7-d;e.CH[u].block_fnum=d<<11|p;e.CH[u].SLOT[l[0]].Incr=-1;if(t.debug>2)console.log("block_fnum=x",e.CH[u].block_fnum.toString(16)," kcode=",e.CH[u].kcode.toString(16)," fc=",e.CH[u].fc.toString(16));break;case 1:e.OPN.ST.fn_h=o&63|0;break;case 2:if(s<256){p=((e.OPN.SL3.fn_h&7)<<8)+o;d=e.OPN.SL3.fn_h>>3;e.OPN.SL3.kcode[u]=d<<2|a.fktable[p>>7];e.OPN.SL3.fc[u]=p<<6>>7-d;e.OPN.SL3.block_fnum[u]=d<<11|p;e.CH[2].SLOT[l[0]].Incr=-1}break;case 3:if(s<256)e.OPN.SL3.fn_h=o&63;break}break;case 176:switch(c){case 0:var v=o>>3&7;e.CH[u].ALGO=o&7;e.CH[u].FB=v;e.CH[u].setupConnection();break;case 1:e.CH[u].pms=(o&7)<<5;e.CH[u].ams=f.ams_depth_shift[o>>4&3];e.CH[u].pan[0]=o&128?n.bitmask:0;e.CH[u].pan[1]=o&64?n.bitmask:0;break}break}};a.SetPrescaler=function(e,r){e.ratio=r||144;e.OPN.ST.scale=e.OPN.ST.clock/e.OPN.ST.rate/e.ratio;if(t.debug)console.log("init_timetables",e.OPN.ST.clock,e.OPN.ST.rate,e.ratio,e.OPN.ST.scale);var i,o,u;var a=e.OPN.ST.scale*(1<<n.FREQ_SH-10);for(i=0;i<4;++i){for(o=0;o<32;++o){u=s.tab[(i<<5)+o];e.OPN.ST.dt_tab[i][o]=u|0;e.OPN.ST.dt_tab[i+4][o]=-e.OPN.ST.dt_tab[i][o]}}if(t.debug>2)console.log("init_timetables dt_tab",ym.OPN.ST.dt_tab);o=4096;while(--o>-1){e.OPN.fn.table[o]=o*32*a|0}e.OPN.fn.max=131072*a|0;e.OPN.eg.timer_add=e.OPN.ST.scale*(1<<n.EG_SH)|0;e.OPN.eg.timer_overflow=3*(1<<n.EG_SH);e.OPN.lfo.timer_add=e.OPN.ST.scale*(1<<n.LFO_SH)|0};e.prototype.init=function(e,n){if(t.debug)console.log("OPN::init("+e+","+n+")");if(!this.chip)this.chip=new m(e,n);else this.chip.ST.clock=e||7670448,this.chip.ST.rate=n||44100;this.ratio=144;this.start=0;this.count=0;N(this.chip)};e.prototype.reset=function(){if(t.debug)console.log("OPN::reset");(function(e){a.SetPrescaler(e,144);e.OPN.eg.timer=0;e.OPN.eg.cnt=0;e.OPN.lfo.timer_overflow=0;e.OPN.lfo.timer=0;e.OPN.lfo.cnt=0;e.OPN.lfo.AM=126;e.OPN.lfo.PM=0;e.OPN.ST.TAC=0;e.OPN.ST.TBC=0;e.OPN.SL3.key_csm=0;e.dacen=0;e.dacout=0;b(e,48);e.OPN.ST.TB=0;e.OPN.ST.TBL=256<<4;e.OPN.ST.TA=0;e.OPN.ST.TAL=1024;T(e,6);var t=182;while(t>=180){if((t&3)!==3)a.WriteReg(e,t,192),a.WriteReg(e,t|256,192);--t}t=178;while(t>=30){if((t&3)!==3)a.WriteReg(e,t,0),a.WriteReg(e,t|256,0);--t}})(this.chip);this.start=0;this.count=0};e.prototype.write=function(e,n){if(t.debug>1)console.log("OPN::write",e.toString(16),n.toString(16));n&=255;this.chip.OPN.ST.address=e&511;var r=this.chip.OPN.ST.address;switch(r&496){case 32:switch(r){case 42:this.chip.dacout=(n-128|0)<<6;break;case 43:this.chip.dacen=n&128;break;default:a.WriteMode(this.chip,r,n);break}break;default:a.WriteReg(this.chip,r,n);break}};e.prototype.read=function(e){return this.chip.OPN.ST.status&255};e.prototype.update=function(e){var n=e*this.ratio;if(t.debug)console.log("==== YM::update","samples="+e,"cycles="+n);var r=[[],[]],i,s,o;var u=!!(this.chip.OPN.ST.mode&192),a;var f=-1;while(++f<this.chip.CH.length){if(!u)this.chip.CH[f].refresh_fc_eg(this.chip);else if(this.chip.CH[f].canCSM){if(this.chip.CH[f].SLOT[l[0]].Incr===-1){this.chip.CH[f].SLOT[l[0]].refresh_fc_eg(this.chip,this.chip.OPN.SL3.fc[1],this.chip.OPN.SL3.kcode[1]);this.chip.CH[f].SLOT[l[1]].refresh_fc_eg(this.chip,this.chip.OPN.SL3.fc[2],this.chip.OPN.SL3.kcode[2]);this.chip.CH[f].SLOT[l[2]].refresh_fc_eg(this.chip,this.chip.OPN.SL3.fc[0],this.chip.OPN.SL3.kcode[0]);this.chip.CH[f].SLOT[l[3]].refresh_fc_eg(this.chip,this.chip.CH[f].fc,this.chip.CH[f].kcode)}}}var c=1*this.chip.OPN.ST.scale,h=e*c+.5|0;t.debugArr.length=0;f=-1;while(++f<h){s=0,o=0;a=!!(this.chip.OPN.SL3.key_csm&2);i=this.chip.CH.length;while(--i>-1){this.chip.CH[i].out=0;this.chip.CH[i].update_ssg_eg();if(!this.chip.dacen)this.chip.CH[i].calculate(this.chip);else if(this.chip.CH[i].canDAC)this.chip.CH[i].out=this.chip.dacout;if(i===0&&t.debugLocal)t.debugArr[t.debugArr.length]=this.chip.CH[i].out;if(this.chip.CH[i].out>8192)this.chip.CH[i].out=8192;else if(this.chip.CH[i].out<-8192)this.chip.CH[i].out=-8192;s+=this.chip.CH[i].out&this.chip.CH[i].pan[0];o+=this.chip.CH[i].out&this.chip.CH[i].pan[1];if(a&&this.chip.CH[i].canCSM){this.chip.CH[i].keyOffCSM(this.chip,l[0]);this.chip.CH[i].keyOffCSM(this.chip,l[1]);this.chip.CH[i].keyOffCSM(this.chip,l[2]);this.chip.CH[i].keyOffCSM(this.chip,l[3])}}w(this.chip);++this.chip.OPN.eg.timer;if(this.chip.OPN.eg.timer>=3){this.chip.OPN.eg.timer=0;++this.chip.OPN.eg.cnt;E(this.chip,this.chip.OPN.eg.cnt)}r[0][f]=s;r[1][f]=o;this.chip.OPN.SL3.key_csm<<=1;g(this.chip);if(a){this.chip.OPN.SL3.key_csm=0}}y(this.chip,e);var p=[[],[]];f=0;i=0;do{p[0][f]=r[0][i|0];p[1][f]=r[1][i|0];i+=c,++f}while(f<e);if(t.debugLocal)console.log(t.debugArr.join(", "));return p};e.prototype.config=function(e){n.bitmask=~((1<<u.BITS-e)-1);var t=this.chip.CH.length;while(--t>-1){if(this.chip.CH[t].pan[0])this.chip.CH[t].pan[0]=n.bitmask;if(this.chip.CH[t].pan[1])this.chip.CH[t].pan[1]=n.bitmask}};e.prototype.load=function(e){};e.prototype.save=function(e){}})(YM2612);
